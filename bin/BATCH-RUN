# !/usr/bin/env bash

BASE=$(pwd)
BASEDIR='experiments'
IDS=(__dummy__)
STORAGE
CLEANUP=''

if [ -z ${STORAGE+x} ]; then
    echo "no storage set.";
    echo "please, set it to the same of basedir `$BASEDIR` if you want the storage to be ignored."
    exit 1
fi

source .py3venv/bin/activate
for ID in "${IDS[@]}"
do
  
  BASEDIR=`cd $BASEDIR; pwd`
  STORAGE=`cd $STORAGE; pwd`
  
  CONFIG=$BASEDIR/$ID'.json'
  LOGDIR=$BASEDIR
  ./bin/dket-experiment-run --config $CONFIG\
    --log-level DEBUG\
    --log-to-stderr --force\
    --logdir $LOGDIR
  
  if [ "$STORAGE" = "$BASEDIR" ]; then
    echo "storage is the same of basedir (no storage). ";
    if [ "$CLEANUP" = true ]; then
      echo "cleaning up the checkpoints and keeping only the eval dump."
      cd $LOGDIR/$ID/eval
      tar -zcvf dump.tar.gz dump
      mv dump.tar.gz ../../$ID.dump.tar.gz
      cd ../..
      rm -rf $ID
      cd ../
      echo "back to $(pwd)"
    fi
  else
    cd $LOGDIR/$ID/eval
    tar -zcvf dump.tar.gz dump
    rm -rf dump
    cd $BASE
    
    cp $CONFIG $STORAGE
    mv $CONFIG'.log' $STORAGE
    mv $BASEDIR/$ID $STORAGE
  fi

done
deactivate
echo 'done'
